---
name: ChIPseq-QC
description: This skill should be used when users need to perform comprehensive quality control for ChIP-seq data using phantompeakqualtools (spp package). It provides workflows for cross-correlation analysis, NSC/RSC calculations, fragment size distribution analysis, and quality score generation from aligned BAM files with reference genome information.
---

# ChIP-seq QC with Phantompeakqualtools

## Overview

Perform comprehensive quality control for ChIP-seq data using the phantompeakqualtools R package (spp). This skill enables systematic evaluation of ChIP-seq data quality through cross-correlation analysis, strand cross-correlation metrics (NSC/RSC), fragment size distribution analysis, and quality score generation.

## Quick Start

To perform basic ChIP-seq QC on a single BAM file:

1. Ensure phantompeakqualtools is installed in R
2. Provide aligned BAM file and reference genome information
3. Run cross-correlation analysis to determine optimal shift size
4. Calculate NSC/RSC metrics for quality assessment
5. Generate fragment size distribution plots
6. Interpret quality scores and metrics

## Core Capabilities

### 1. Cross-Correlation Analysis

Perform cross-correlation analysis to identify optimal shift sizes and assess data quality:

- Calculate cross-correlation between forward and reverse strands
- Identify optimal shift size for peak calling
- Generate cross-correlation plots
- Assess signal-to-noise ratio

### 2. NSC/RSC Calculations

Compute normalized strand cross-correlation (NSC) and relative strand cross-correlation (RSC) metrics:

- **NSC**: Ratio of maximum cross-correlation to background cross-correlation
- **RSC**: Ratio of fragment-length cross-correlation to read-length cross-correlation
- **Quality thresholds**: NSC > 1.05 (good), RSC > 0.8 (good)
- Interpret metrics for different ChIP targets (TF vs histone marks)

### 3. Fragment Size Distribution

Analyze fragment size distributions and quality metrics:

- Generate fragment size distribution plots
- Calculate fragment length statistics
- Assess library complexity
- Identify potential technical artifacts

### 4. Quality Score Generation

Generate comprehensive quality scores and reports:

- Quality scores based on cross-correlation metrics
- Automated quality assessment
- Batch processing for multiple samples
- Summary reports with pass/fail indicators

## Workflow

### Prerequisites

- Aligned BAM files (coordinate-sorted, indexed)
- Reference genome information (hg38, mm10, etc.)
- R with phantompeakqualtools package installed
- Sufficient memory for BAM file processing

### Installation

Install phantompeakqualtools in R:

```r
# Install from Bioconductor
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("phantompeakqualtools")

# Or install from GitHub
install.packages("devtools")
devtools::install_github("hms-dbmi/spp")
```

### Basic Usage

Process a single ChIP-seq BAM file:

```r
library(spp)

# Load BAM file
chip.data <- read.bam.tags("sample_chip.bam")

# Calculate cross-correlation
cross.corr <- get.binding.characteristics(chip.data$tags, chip.data$quality)

# Extract metrics
nsc <- cross.corr$cross.correlation$nsc
rsc <- cross.corr$cross.correlation$rsc
optimal.shift <- which.max(cross.corr$cross.correlation[,2])

# Generate quality report
quality.score <- (nsc > 1.05 & rsc > 0.8)
```

### Batch Processing

Process multiple samples with automated reporting:

```r
# Define sample list
samples <- c("chip_rep1.bam", "chip_rep2.bam", "input.bam")

# Process all samples
results <- lapply(samples, function(bam.file) {
  data <- read.bam.tags(bam.file)
  cross.corr <- get.binding.characteristics(data$tags, data$quality)
  return(list(
    nsc = cross.corr$cross.correlation$nsc,
    rsc = cross.corr$cross.correlation$rsc,
    optimal.shift = which.max(cross.corr$cross.correlation[,2])
  ))
})
```

## Quality Assessment Guidelines

### Interpretation of Metrics

- **Excellent quality**: NSC > 1.1, RSC > 1
- **Good quality**: NSC > 1.05, RSC > 0.8
- **Marginal quality**: NSC > 1.05, RSC > 0.5
- **Poor quality**: NSC < 1.05 or RSC < 0.5

### Target-Specific Expectations

- **Transcription factors**: High NSC/RSC values expected
- **Histone marks**: Variable NSC/RSC depending on mark
- **Input controls**: Lower NSC/RSC values expected
- **Broad marks**: Different cross-correlation patterns

## Troubleshooting

### Common Issues

- **Memory errors**: Process BAM files in chunks or subset chromosomes
- **Low NSC/RSC**: Check library complexity and sequencing depth
- **No optimal shift**: May indicate poor IP efficiency
- **Installation issues**: Ensure all R dependencies are installed

### Best Practices

- Always include input/control samples for comparison
- Process replicates separately and compare metrics
- Consider sequencing depth when interpreting metrics
- Use consistent parameters across samples for fair comparison

## Resources

This skill includes the following bundled resources:

### scripts/

- `batch_chipseq_qc.R` - R script for batch processing multiple ChIP-seq BAM files
  - Processes multiple samples in one run
  - Generates JSON and CSV summary reports
  - Handles errors gracefully
  - Usage: `Rscript scripts/batch_chipseq_qc.R sample_sheet.csv --output-dir results --genome mm10`

### references/

- `metrics_interpretation.md` - Detailed guide for interpreting phantompeakqualtools metrics
  - NSC and RSC definitions and formulas
  - Quality assessment by ChIP target type
  - Troubleshooting common issues
  - Best practices for interpretation

### assets/

- `sample_sheet_template.csv` - Template for batch processing
  - Required columns: sample, bam_file, condition, replicate, antibody, genome
  - Example structure for organizing ChIP-seq samples
  - Can be customized for specific experimental designs
