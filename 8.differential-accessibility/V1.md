---
name: differential-accessibility
description: This skill should be used when users need to perform differential accessibility analysis for ATAC-seq data using DESeq2, including count matrix generation from BAM files, quality control, statistical analysis, and visualization of differentially accessible regions between conditions.
---

# ATAC-seq Differential Accessibility Analysis with DESeq2

## Overview

Perform comprehensive differential accessibility analysis for ATAC-seq data using DESeq2. This workflow handles count matrix generation from BAM files, statistical analysis of differential accessibility, quality control, and visualization of results.

## Workflow Decision Tree

To determine the appropriate workflow path:

1. **If starting from BAM files and consensus peaks**: Follow the complete workflow from count matrix generation
2. **If starting from existing count matrix**: Skip to DESeq2 analysis
3. **If analyzing multiple conditions**: Use the multi-group comparison workflow
4. **If working with replicates**: Ensure proper sample metadata structure

## Complete Workflow: From BAM Files to Differential Analysis

### Step 1: Generate Consensus Peaks

To create a unified set of peaks for count matrix generation:

```bash
# Merge replicate peaks using bedtools
bedtools merge -i <replicate1_peaks.bed> <replicate2_peaks.bed> > consensus_peaks.bed

# Or use IDR for more stringent consensus
idr --samples replicate1_peaks.narrowPeak replicate2_peaks.narrowPeak \
    --output-file idr_peaks.narrowPeak \
    --plot
```

### Step 2: Generate Count Matrix

Use featureCounts or similar tools to count reads in peaks:

```bash
# Using featureCounts
featureCounts -T 8 -p -a consensus_peaks.bed \
    -o atac_counts.txt \
    sample1.bam sample2.bam sample3.bam

# Using bedtools multicov
bedtools multicov -bams sample1.bam sample2.bam sample3.bam \
    -bed consensus_peaks.bed > atac_counts.txt
```

### Step 3: Prepare Sample Metadata

Create a sample metadata file (samples.csv):

```csv
sample,condition,replicate
sample1,K562,1
sample2,K562,2
sample3,GM12878,1
sample4,GM12878,2
```

### Step 4: DESeq2 Analysis in R

Load required libraries and prepare data:

```r
library(DESeq2)
library(ggplot2)
library(EnhancedVolcano)

# Read count matrix and sample metadata
counts <- read.table("atac_counts.txt", header=TRUE, row.names=1)
colData <- read.csv("samples.csv", row.names=1)

# Remove annotation columns if present
counts_matrix <- counts[, -c(1:6)]

# Create DESeq2 object
dds <- DESeqDataSetFromMatrix(countData = counts_matrix,
                              colData = colData,
                              design = ~ condition)

# Pre-filter low count peaks
dds <- dds[rowSums(counts(dds)) >= 10, ]

# Run DESeq2 analysis
dds <- DESeq(dds)
```

### Step 5: Extract Results

```r
# Get results for specific comparison
res <- results(dds, contrast=c("condition", "K562", "GM12878"))

# Apply multiple testing correction
res <- res[order(res$padj), ]

# Write results to file
write.csv(as.data.frame(res), file="differential_peaks_results.csv")
```

## Quality Control and Visualization

### Sample Clustering

```r
# Variance stabilizing transformation for visualization
vsd <- vst(dds, blind=FALSE)

# PCA plot
pcaData <- plotPCA(vsd, intgroup="condition", returnData=TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))

ggplot(pcaData, aes(PC1, PC2, color=condition)) +
  geom_point(size=3) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  coord_fixed()
```

### Volcano Plot

```r
# Create volcano plot
EnhancedVolcano(res,
    lab = rownames(res),
    x = 'log2FoldChange',
    y = 'pvalue',
    pCutoff = 10e-6,
    FCcutoff = 1.0,
    pointSize = 3.0,
    labSize = 6.0,
    title = 'Differential Accessibility: K562 vs GM12878')
```

## Advanced Analysis Options

### Multi-group Comparisons

For experiments with multiple conditions:

```r
# Create design with multiple factors
dds_multi <- DESeqDataSetFromMatrix(countData = counts_matrix,
                                   colData = colData,
                                   design = ~ batch + condition)

# Extract results for specific comparisons
res1 <- results(dds_multi, contrast=c("condition", "K562", "GM12878"))
res2 <- results(dds_multi, contrast=c("condition", "K562", "HEK293"))
```

### Time Course Analysis

For time series ATAC-seq data:

```r
# Use likelihood ratio test for time course
dds_time <- DESeq(dds, test="LRT", reduced=~1)
res_time <- results(dds_time)
```

## Troubleshooting Common Issues

### Low Count Peaks

- Increase pre-filtering threshold: `rowSums(counts(dds)) >= 20`
- Consider using independent filtering: `independentFiltering = TRUE`

### Batch Effects

- Include batch in design formula: `design = ~ batch + condition`
- Use `removeBatchEffect()` from limma package if needed

### Convergence Issues

- Increase iterations: `DESeq(dds, betaPrior=FALSE, fitType="local")`
- Try alternative fit types: `fitType="parametric"` or `fitType="mean"`

## Resources

### Required R Packages

- DESeq2: Differential expression analysis
- ggplot2: Visualization
- EnhancedVolcano: Volcano plots
- pheatmap: Heatmap visualization
- ComplexHeatmap: Advanced heatmaps

### File Formats

- **BAM files**: Aligned sequencing reads
- **BED/narrowPeak**: Peak coordinates
- **Count matrix**: Tab-delimited file with counts per peak
- **Sample metadata**: CSV file with experimental design

### Quality Metrics

- Library size normalization
- Dispersion estimation
- Principal component analysis
- Sample correlation heatmaps