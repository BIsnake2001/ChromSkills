---
name: hic-normalization
description: Automatically detect and normalize Hi-C data. Only .cool or .mcool file is supported. All .mcool files are then checked for existing normalization (supports bins/weight only) and balanced if none of the normalizations exist.
---

## Overview

This skill performs Hi-C data normalization on .mcool files.  
Main steps include:

- Refer to the **Inputs & Outputs** section to verify required files and output structure.
- **Check normalization status** per resolution (supports bins/weight columns only).
- If a resolution is not normalized, perform normalization with cooler balance (ICE) to create bins/weight.
- **Verify normalization** and emit a concise report on the file, resolution, and normalization status.

---

## When to use this skill

Use the hic-normalization pipeline when:

- You need to ensure that Hi-C data is normalized for downstream analysis.
- Your data comes in .cool or .mcool formats, and you want to check or refresh normalization status (ICE normalization).

This tool assumes the file already has correct genome assembly and chromosome names.

---

## Inputs & Outputs

### Inputs

- Accepted file format: .mcool

### Outputs

```bash
hic_norm/
    normalization_report.txt  # A brief log/report indicating which resolutions were detected, normalized, or skipped.
```
---

## Decision Tree

### Step 1: Inputs & Requirements

- Accepted input: .mcool file format.

```bash
# Identify the file type
file input.mcool || true
# List the layout of the .mcool file, including resolutions and datasets
cooler ls K562.mcool
```

### Step 2: Check Normalization Status (per resolution) on .mcool

A resolution is considered **normalized** if **either** of the following is present under /resolutions/<RES>/bins/:

- weight (ICE weights generated by cooler balance).

```bash
# Check for ICE weights
h5ls -r work.mcool | grep "/resolutions/.*/bins/weight" || echo "no weight columns found"
```

### Step 3: Normalize .mcool (if missing at a resolution)

Use cooler balance (ICE) to compute weights for any resolution lacking normalization.

```bash
for res in <all resolutions>; do
  if h5ls -r work.mcool | grep -q "/resolutions/${res}/bins"; then
    if ! h5ls -r work.mcool | grep -q "/resolutions/${res}/bins/weight"; then
      echo "[balance] work.mcool @ ${res}"
      cooler balance --nproc 8 --ignore-diags 2 "work.mcool::/resolutions/${res}"
    else
      echo "[skip] weights already present @ ${res}"
    fi
  else
    echo "[skip] resolution ${res} not found"
  fi
done
```

**Notes:**
- cooler balance writes /resolutions/<RES>/bins/weight.
- Useful flags when convergence is tricky: 
  - --mad-max <float>
  - --ignore-diags <int>
  - --converge <float>
  - --max-iters <int>

### Step 4: Post-Normalization Verification

Verify the presence of the normalization columns:

```bash
h5ls -r work.mcool | egrep "/resolutions/.*/bins/weight"
```
---

## Notes & Troubleshooting

- **Normalization fails to converge**: Increase iterations or adjust the convergence criteria (--max-iters, --converge)
