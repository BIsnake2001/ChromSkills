---
name: hic-normalization
description: Automatically detect and normalize Hi-C data. Only .cool or .mcool file is supported; All .mcool files are then checked for existing normalization (upports `bins/weight` only) and balanced if none of the normalization exist. 
---


## Overview
- For the resulting .mcool: check normalization status per resolution (supports `bins/weight` columns only).
- If a resolution is not normalized, perform normalization with `cooler balance` (ICE) to create/refresh `bins/weight`.
- Verify normalization and emit a concise report (file, resolution, normalization columns present).
---

## Decision Tree

### 1) Inputs & Requirements
- Accepted inputs: `.mcool`.
- This skill **does not** rename chromosomes or fix genome assemblies (assumes they are correct).

> Quick probes
```bash
# Identify the file type
file input.mcool || true

# List .mcool layout (all resolutions and datasets)
h5ls -r input.mcool | head
```

---

### 2) Check normalization status (per resolution) on `.mcool`
A resolution is considered **normalized** if **either** of the following is present under `/resolutions/<RES>/bins/`:
- `weight` (ICE weights generated by `cooler balance`)

> Examples
```bash
# Check for ICE weights
h5ls -r work.mcool | grep "/resolutions/.*/bins/weight" || echo "no weight columns found"

# Check for Juicer-style columns (if available)
h5ls -r work.mcool | egrep "/resolutions/.*/bins/(KR|VC|VC_SQRT|SCALE)" || echo "no KR/VC columns found"
```

---

### 3) Normalize `.mcool` (if missing at a resolution)
Use `cooler balance` (ICE) to compute weights for any resolution lacking normalization.

> Normalize selected resolutions
```bash
for res in <all resolutions>; do
  if h5ls -r work.mcool | grep -q "/resolutions/${res}/bins"; then
    if ! h5ls -r work.mcool | grep -q "/resolutions/${res}/bins/weight"; then
      echo "[balance] work.mcool @ ${res}"
      cooler balance --nproc 8 --ignore-diags 2 "work.mcool::/resolutions/${res}"
    else
      echo "[skip] weights already present @ ${res}"
    fi
  else
    echo "[skip] resolution ${res} not found"
  fi
done
```

**Notes**
- `cooler balance` writes `/resolutions/<RES>/bins/weight`.
- Useful flags when convergence is tricky: `--mad-max <float>`, `--ignore-diags <int>`, `--converge <float>`, `--max-iters <int>`.

---

### 5) Post-normalization verification
> Presence of normalization columns
```bash
h5ls -r work.mcool | egrep "/resolutions/.*/bins/weight"
```
---

## Outputs
- A `.mcool` file with per-resolution normalization:
  - `bins/weight` (ICE weights)
- A brief log/report from the shell indicating which resolutions were detected, normalized, or skipped.
