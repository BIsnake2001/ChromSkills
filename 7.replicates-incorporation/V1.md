---
name: replicates-incorporation
description: This skill should be used when users need to handle multiple replicates in ChIP-seq or ATAC-seq data, including IDR analysis for TF ChIP-seq, overlap-based consensus for broad histone marks, and consensus peak generation for ATAC-seq data.
---

# Replicates Consensus Skill

## Overview

This skill provides comprehensive workflows for handling multiple replicates in ChIP-seq and ATAC-seq data analysis. It includes IDR analysis for transcription factor ChIP-seq, overlap-based consensus generation for broad histone marks, and consensus peak calling for ATAC-seq data to ensure reproducibility and generate high-confidence peak sets.

## Workflow Decision Tree

To determine the appropriate replicate handling strategy, follow this decision tree:

1. **Experiment Type Assessment**
   - **TF ChIP-seq (narrow peaks)**: Use IDR workflow for optimal/conservative peak sets
   - **Broad Histone Marks (H3K27me3, H3K9me3, etc.)**: Use overlap-based consensus generation
   - **ATAC-seq**: Use consensus peak calling with signal correlation analysis

2. **Replicate Count**
   - **2 replicates**: Full IDR or overlap analysis
   - **3+ replicates**: Consensus peaks (≥2 of N replicates)
   - **Single replicate**: Use with caution; consider pooling with other experiments

## TF ChIP-seq - IDR Workflow

### Step 1: Call Peaks on Individual Replicates

Call peaks on each replicate using the `peak-calling-core` skill:
```bash
# For each replicate
macs2 callpeak -t rep1.bam -c input_rep1.bam -f BAM -g hs -n TF_rep1 --outdir peaks -q 0.05
macs2 callpeak -t rep2.bam -c input_rep2.bam -f BAM -g hs -n TF_rep2 --outdir peaks -q 0.05
```

### Step 2: Call Peaks on Pooled Data

Pool replicates for increased sensitivity:
```bash
samtools merge -f TF_pooled.bam rep1.bam rep2.bam
samtools merge -f input_pooled.bam input_rep1.bam input_rep2.bam
macs2 callpeak -t TF_pooled.bam -c input_pooled.bam -f BAM -g hs -n TF_pooled --outdir peaks -q 0.05
```

### Step 3: IDR Analysis

**Install IDR (if not available):**
```bash
# Install via conda
conda install -c bioconda idr

# Or install via pip
pip install idr
```

**Run IDR Analysis:**
```bash
# Sort peaks by -log10(p-value)
sort -k8,8nr peaks/TF_rep1_peaks.narrowPeak > peaks/TF_rep1_sorted.narrowPeak
sort -k8,8nr peaks/TF_rep2_peaks.narrowPeak > peaks/TF_rep2_sorted.narrowPeak

# Run IDR
idr --samples peaks/TF_rep1_sorted.narrowPeak peaks/TF_rep2_sorted.narrowPeak \
    --peak-list peaks/TF_pooled_peaks.narrowPeak \
    --input-file-type narrowPeak \
    --output-file peaks/TF_idr.narrowPeak \
    --plot \
    --log-output-file peaks/TF_idr.log

# Generate optimal and conservative peak sets
awk '$11 <= 540' peaks/TF_idr.narrowPeak > peaks/TF_optimal_peaks.narrowPeak
awk '$11 <= 830' peaks/TF_idr.narrowPeak > peaks/TF_conservative_peaks.narrowPeak
```

### Step 4: IDR Interpretation

- **IDR ≤ 0.05 (540 in -log10 scale)**: Optimal reproducible peaks (use for downstream analysis)
- **IDR ≤ 0.01 (830 in -log10 scale)**: Conservative reproducible peaks (higher stringency)
- **IDR > 0.05**: Irreproducible peaks (discard)

## Broad Histone Marks - Overlap Workflow

### Step 1: Call Broad Peaks on Individual Replicates

Call broad peaks on each replicate:
```bash
macs2 callpeak -t rep1.bam -c input_rep1.bam -f BAM -g hs -n HM_rep1 --outdir peaks --broad --broad-cutoff 0.1
macs2 callpeak -t rep2.bam -c input_rep2.bam -f BAM -g hs -n HM_rep2 --outdir peaks --broad --broad-cutoff 0.1
```

### Step 2: Find Overlapping Peaks

Find peaks with ≥50% reciprocal overlap:
```bash
# Convert to BED format
cut -f1-4,7 peaks/HM_rep1_peaks.broadPeak > peaks/HM_rep1.bed
cut -f1-4,7 peaks/HM_rep2_peaks.broadPeak > peaks/HM_rep2.bed

# Find overlapping peaks
bedtools intersect -a peaks/HM_rep1.bed -b peaks/HM_rep2.bed -f 0.5 -r -wa > peaks/HM_overlap_rep1.bed
bedtools intersect -a peaks/HM_rep2.bed -b peaks/HM_rep1.bed -f 0.5 -r -wa > peaks/HM_overlap_rep2.bed

# Merge overlapping peaks
cat peaks/HM_overlap_rep1.bed peaks/HM_overlap_rep2.bed | sort -k1,1 -k2,2n | bedtools merge -i - > peaks/HM_consensus_peaks.bed
```

## ATAC-seq - Consensus Workflow

### Step 1: Call Peaks on Individual Replicates

Call peaks on each ATAC-seq replicate:
```bash
macs2 callpeak -t rep1.bam -f BAM -g hs -n ATAC_rep1 --outdir peaks --nomodel --shift -100 --extsize 200 -q 0.05
macs2 callpeak -t rep2.bam -f BAM -g hs -n ATAC_rep2 --outdir peaks --nomodel --shift -100 --extsize 200 -q 0.05
```

### Step 2: Generate Consensus Peaks

Generate consensus peaks present in at least 2 of N replicates:
```bash
# Convert to BED format
cut -f1-4,7 peaks/ATAC_rep1_peaks.narrowPeak > peaks/ATAC_rep1.bed
cut -f1-4,7 peaks/ATAC_rep2_peaks.narrowPeak > peaks/ATAC_rep2.bed

# Find peaks present in at least 2 replicates
cat peaks/ATAC_rep1.bed peaks/ATAC_rep2.bed | sort -k1,1 -k2,2n | bedtools merge -i - -c 4,5 -o distinct,mean > peaks/ATAC_consensus_peaks.bed
```

### Step 3: Optional Pooled Analysis

For increased sensitivity:
```bash
samtools merge -f ATAC_pooled.bam rep1.bam rep2.bam
macs2 callpeak -t ATAC_pooled.bam -f BAM -g hs -n ATAC_pooled --outdir peaks --nomodel --shift -100 --extsize 200 -q 0.05
```

## Reproducibility Analysis

### TF ChIP-seq - IDR Metrics

**Calculate reproducibility metrics:**
```bash
total_peaks=$(wc -l < peaks/TF_pooled_peaks.narrowPeak)
optimal_peaks=$(wc -l < peaks/TF_optimal_peaks.narrowPeak)
reproducibility_rate=$(echo "scale=2; $optimal_peaks / $total_peaks * 100" | bc)
echo "Reproducibility rate: $reproducibility_rate%"
```

### Broad Histone Marks - Overlap Metrics

**Calculate overlap statistics:**
```bash
# Calculate Jaccard index
rep1_count=$(wc -l < peaks/HM_rep1_peaks.broadPeak)
rep2_count=$(wc -l < peaks/HM_rep2_peaks.broadPeak)
overlap_count=$(wc -l < peaks/HM_consensus_peaks.bed)

jaccard_index=$(echo "scale=3; $overlap_count / ($rep1_count + $rep2_count - $overlap_count)" | bc)
echo "Jaccard index: $jaccard_index"

# Calculate overlap percentages
overlap_rep1=$(echo "scale=2; $overlap_count / $rep1_count * 100" | bc)
overlap_rep2=$(echo "scale=2; $overlap_count / $rep2_count * 100" | bc)
echo "Overlap with rep1: $overlap_rep1%"
echo "Overlap with rep2: $overlap_rep2%"
```

### ATAC-seq - Correlation Analysis

**Calculate signal correlation between replicates:**
```bash
# Generate bigWig files for correlation
bamCoverage -b rep1.bam -o rep1.bw --binSize 50 --normalizeUsing RPKM
bamCoverage -b rep2.bam -o rep2.bw --binSize 50 --normalizeUsing RPKM

# Calculate Pearson correlation
multiBigwigSummary bins -b rep1.bw rep2.bw -o correlation.npz
plotCorrelation -in correlation.npz -c pearson -p heatmap -o correlation_heatmap.png
```

## Practical Examples

### Example 1: CTCF ChIP-seq with 2 Replicates
```bash
# Auto-detect and run
EXPERIMENT_TYPE="TF"
TREATMENT_FILES=("wt_CTCF_rep1_dedup.bam" "wt_CTCF_rep2_dedup.bam")
CONTROL_FILES=("wt_input_rep1_dedup.bam" "wt_input_rep2_dedup.bam")

# Run TF workflow
for i in {1..2}; do
    macs2 callpeak -t ${TREATMENT_FILES[$i-1]} -c ${CONTROL_FILES[$i-1]} -f BAM -g mm -n CTCF_rep$i --outdir peaks -q 0.05
done

# IDR analysis
sort -k8,8nr peaks/CTCF_rep1_peaks.narrowPeak > peaks/CTCF_rep1_sorted.narrowPeak
sort -k8,8nr peaks/CTCF_rep2_peaks.narrowPeak > peaks/CTCF_rep2_sorted.narrowPeak
idr --samples peaks/CTCF_rep1_sorted.narrowPeak peaks/CTCF_rep2_sorted.narrowPeak \
    --output-file peaks/CTCF_idr.narrowPeak --plot
```

### Example 2: H3K27me3 with 2 Replicates
```bash
# Auto-detect and run
EXPERIMENT_TYPE="BROAD"
TREATMENT_FILES=("wt_H3K27me3_rep1.bam" "wt_H3K27me3_rep2.bam")

# Run broad mark workflow
for i in {1..2}; do
    macs2 callpeak -t ${TREATMENT_FILES[$i-1]} -f BAM -g mm -n H3K27me3_rep$i --outdir peaks --broad --broad-cutoff 0.1
done

# Find overlapping peaks
cut -f1-4,7 peaks/H3K27me3_rep1_peaks.broadPeak > peaks/H3K27me3_rep1.bed
cut -f1-4,7 peaks/H3K27me3_rep2_peaks.broadPeak > peaks/H3K27me3_rep2.bed
bedtools intersect -a peaks/H3K27me3_rep1.bed -b peaks/H3K27me3_rep2.bed -f 0.5 -r -wa > peaks/H3K27me3_overlap.bed
```

## Quality Control Metrics

### TF ChIP-seq QC Report
```bash
echo "=== TF ChIP-seq QC Report ==="
echo "Optimal peaks: $(wc -l < peaks/TF_optimal_peaks.narrowPeak)"
echo "Conservative peaks: $(wc -l < peaks/TF_conservative_peaks.narrowPeak)"
echo "IDR passing rate: $(echo "scale=2; $(wc -l < peaks/TF_optimal_peaks.narrowPeak) / $(wc -l < peaks/TF_pooled_peaks.narrowPeak) * 100" | bc)%"
```

### Broad Histone Mark QC Report
```bash
echo "=== Broad Histone Mark QC Report ==="
echo "Consensus peaks: $(wc -l < peaks/HM_consensus_peaks.bed)"
echo "Rep1 peaks: $(wc -l < peaks/HM_rep1_peaks.broadPeak)"
echo "Rep2 peaks: $(wc -l < peaks/HM_rep2_peaks.broadPeak)"
```

### ATAC-seq QC Report
```bash
echo "=== ATAC-seq QC Report ==="
echo "Consensus peaks: $(wc -l < peaks/ATAC_consensus_peaks.bed)"
echo "Rep1 peaks: $(wc -l < peaks/ATAC_rep1_peaks.narrowPeak)"
echo "Rep2 peaks: $(wc -l < peaks/ATAC_rep2_peaks.narrowPeak)"
```

## Best Practices

### TF ChIP-seq
1. **Use IDR analysis** for replicate reproducibility
2. **Use optimal peaks (IDR ≤ 0.05)** for downstream analysis
3. **Include pooled analysis** for increased sensitivity
4. **Validate with visual inspection** in genome browsers

### Broad Histone Marks
1. **Use reciprocal overlap** (≥50%) for consensus peaks
2. **Keep duplicates** for broad domain analysis
3. **Use relaxed q-value cutoffs** (0.1) for broad domains
4. **Assess domain continuity** in genome browsers

### ATAC-seq
1. **Generate consensus peaks** (≥2 of N replicates)
2. **Assess signal correlation** between replicates
3. **Use nomodel mode** with proper shifting parameters
4. **Validate accessibility patterns** in genome browsers

### General Guidelines
1. **Document all thresholds** and parameters used
2. **Generate comprehensive QC reports** for each analysis
3. **Use appropriate overlap thresholds** for different experiment types
4. **Validate results visually** in genome browsers

## Troubleshooting

- **Low reproducibility**: Check replicate quality and sequencing depth
- **Poor IDR performance**: Verify peak calling parameters and sample quality
- **Low overlap rates**: Consider adjusting overlap thresholds or q-value cutoffs
- **No consensus peaks**: Check if replicates are from the same biological condition

## Output

This skill generates reproducible peak sets for downstream analysis:
- **TF ChIP-seq**: Optimal and conservative peak sets from IDR analysis
- **Broad Histone Marks**: Consensus peaks from reciprocal overlap
- **ATAC-seq**: Consensus peaks present in multiple replicates

---

**Note**: This skill focuses on replicate handling and consensus generation. For core peak calling functionality, use the companion `peak-calling-core` skill.
