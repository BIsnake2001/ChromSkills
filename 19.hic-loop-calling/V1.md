---
name: hic-loop-calling
description: This skill should be used when users need to perform comprehensive loop calling on Hi-C .cool/.mcool datasets using HiCExplorer. It implements the full workflow including loop detection, parameter optimization, biological validation, and quality control with automated resolution selection and comprehensive output generation.
---

# Hi-C Loop Calling

## Overview

This skill provides automated loop calling for Hi-C data using HiCExplorer's sophisticated algorithms. It identifies chromatin loops through negative binomial modeling and Wilcoxon testing, with automated parameter optimization, biological validation, and comprehensive quality control.

## When to Use This Skill

Use this skill when:
- Identifying chromatin loops in Hi-C data
- Analyzing 3D chromatin architecture
- Generating loop annotations for genome browsers
- Performing quality assessment of Hi-C loop data
- Optimizing loop calling parameters for specific datasets

## Quick Start

To run the complete loop calling workflow on a .mcool file:

```bash
python scripts/loop_calling_workflow.py \
  input.mcool \
  --peak-file ctcf_peaks.bed \
  --output-dir loop_output
```

## Complete Workflow

### Step 1: Resolution Selection & Extraction
- Automatically selects optimal resolution from .mcool (10kb → 5kb → 25kb)
- Extracts single resolution for loop calling
- Handles both .cool and .mcool file formats

### Step 2: Parameter Optimization (Optional)
- Uses `hicHyperoptDetectLoops` with protein peaks
- Optimizes loop calling parameters for specific datasets
- Generates optimized parameter set

### Step 3: Loop Detection
- Runs `hicDetectLoops` with optimized/default parameters
- Uses negative binomial model + Wilcoxon test
- Applies multiple significance and strength filters

### Step 4: Output Generation
- Creates bedGraph format with loop coordinates and p-values
- Converts to BEDPE format for interoperability
- Generates comprehensive QC metrics and plots

### Step 5: Biological Validation
- Validates loop anchors against protein binding sites (CTCF/cohesin)
- Calculates validation rates and overlap statistics
- Generates validation reports

### Step 6: Visualization
- Creates heatmap visualizations with loop overlays
- Generates summary plots and distance distributions
- Produces publication-ready figures

## Output Files

### Primary Outputs
- `*_loops.bedgraph` - Loop coordinates and p-values (HiCExplorer format)
- `*_loops.bedpe` - Loop coordinates in BEDPE format
- `*_optimized_params.json` - Optimized parameters (if hyperopt used)

### Validation Outputs
- `*_validation.tsv` - Loop validation statistics
- Validation rates with protein peaks

### Visualization Outputs
- `*_heatmap_*.png` - Contact maps with loop overlays
- `*_qc_plots.png` - Comprehensive QC visualizations

### QC Outputs
- `*_qc_metrics.json` - Quantitative QC metrics
- Loop counts, distances, p-values, validation rates

## Scripts Reference

### loop_calling_workflow.py
Main workflow script that processes .cool/.mcool files through the complete loop calling pipeline:
- Automated resolution selection and extraction
- Parameter optimization with hyperopt
- Loop detection with comprehensive filtering
- Biological validation and quality control
- Support for single files or batch processing

## References

### HiCExplorer Commands
Load `references/hicexplorer_commands.md` for complete command reference:
- `hicDetectLoops` parameters and usage
- `hicHyperoptDetectLoops` for parameter optimization
- `hicValidateLocations` for biological validation
- `hicPlotMatrix` for visualization

### Loop Calling Methods
Load `references/loop_calling_methods.md` for detailed methodology:
- Negative binomial model + Wilcoxon test algorithm
- Parameter effects and optimization strategies
- Resolution considerations and selection
- Comparison with other loop calling methods

### QC and Validation
Load `references/qc_validation.md` for quality assessment:
- Biological validation with protein peaks
- Distance distribution analysis
- Quality metrics and scoring
- Troubleshooting poor results

## Prerequisites

Ensure these tools are installed:
- `hicexplorer` (for loop calling and analysis)
- `cooler` (for .mcool file handling)
- `matplotlib`, `seaborn` (for plotting)
- `pandas`, `numpy` (for data processing)

## Parameter Recommendations

### Default Parameters (10 kb resolution)
- `--max-loop-distance 2000000` (2 Mb)
- `--window-size 10`
- `--peak-width 6`
- `--pvalue-preselection 0.05`
- `--pvalue 0.025`
- `--peak-interactions-threshold 10`
- `--obsexp-threshold 1.5`

### Resolution Settings
- **10 kb:** Default for most applications
- **5 kb:** For very deep sequencing
- **25 kb:** For shallow datasets

### Quality Thresholds
- **Validation rate:** >30% with CTCF (good), >50% (excellent)
- **Loop distance:** Majority <2 Mb
- **P-value distribution:** Smooth with good significance

## Best Practices

### Data Preparation
- Ensure Hi-C data is properly normalized (ICE/KR)
- Verify resolution availability in .mcool files
- Check sequencing depth requirements
- Use cell-type matched protein peaks for validation

### Parameter Optimization
- Start with default parameters
- Use hyperopt with CTCF peaks for optimization
- Validate against known benchmarks (e.g., GM12878)
- Adjust based on data quality and biological expectations

### Quality Control
- Check validation rates with multiple proteins
- Verify distance distribution patterns
- Assess per-chromosome consistency
- Generate visualizations for manual inspection

### Interpretation
- Loops typically anchor at CTCF/cohesin sites
- Distance correlates with functional categories
- Validation rates indicate biological relevance
- Compare with published datasets for benchmarking
